@{
    ViewData["Title"] = "Kuyu Ve Yüzey Görselleştirmesi";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        #drop-zone {
            border: 2px dashed #007bff;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            margin: 20px;
            font-size: 18px;
            color: #007bff;
        }

        #graph-container {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }

        #values {
            margin-top: 20px;
            background: #ffffff;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /*başta gizli*/
        #palette-container {
            display: none; 
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="drop-zone">Sürükleyip bırakın veya dosya seçin</div>
        <div id="palette-container">
            <label for="palette-select">Renk Paleti Seçiniz:</label>
            <select id="palette-select">
                <option value="Viridis">Viridis</option>
                <option value="Cividis">Cividis</option>
                <option value="Plasma">Plasma</option>
                <option value="Inferno">Inferno</option>
                <option value="Magma">Magma</option>
                <option value="Rainbow">Rainbow</option>
                <option value="Jet">Jet</option>
                <option value="Hot">Hot</option>
                <option value="Electric">Electric</option>
                <option value="Earth">Earth</option>
                <option value="YlGnBu">YlGnBu</option>
                <option value="YlOrRd">YlOrRd</option>
            </select>
        </div>
        <div id="graph-container">
            <div id="combined-plot" style="max-width: 900px; height: 650px;"></div>
        </div>
        <input type="file" id="file-input" style="display:none;" />
       
        <div id="values">
            <h3>Computed Values:</h3>
            <p id="xMin"></p>
            <p id="xMax"></p>
            <p id="yMin"></p>
            <p id="yMax"></p>
            <p id="zMin"></p>
            <p id="zMax"></p>
            <p id="maxXYRange"></p>
            <p id="zRange"></p>
        </div>
    </div>
    <script>

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.style.backgroundColor = '#e1e1e1';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = '';
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.style.backgroundColor = '';
            const files = event.dataTransfer.files;
            if (files.length) {
                handleFiles(files);
            }
        });

        fileInput.addEventListener('change', () => {
            const files = fileInput.files;
            if (files.length) {
                handleFiles(files);
            }
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        function handleFiles(files) {
            if (files.length < 4) {
                alert('Lütfen en az 4 dosya seçin (3 JSON ve 1 CSV).');
                return;
            }

            const jsonFiles = [];
            let csvFile = null;

            Array.from(files).forEach(file => {
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    jsonFiles.push(file);
                } else if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    csvFile = file;
                } else {
                    alert('Sadece JSON ve CSV dosyaları kabul edilir.');
                }
            });

            if (jsonFiles.length !== 3 || !csvFile) {
                alert('Lütfen 3 JSON dosyası ve 1 CSV dosyası yükleyin.');
                return;
            }

            const jsonReaders = [];
            const jsonDataArray = [];

            jsonFiles.forEach((file, index) => {
                const reader = new FileReader();
                jsonReaders.push(reader);
                reader.onload = (event) => {
                    const jsonData = JSON.parse(event.target.result);
                    jsonDataArray[index] = jsonData;
                    if (jsonDataArray.length === jsonFiles.length) {
                        loadCSVData(csvFile, jsonDataArray);
                    }
                };
                reader.readAsText(file);
            });
        }

        function loadCSVData(csvFile, jsonDataArray) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const csvText = event.target.result;
                processCSV(csvText, jsonDataArray);
            };
            reader.readAsText(csvFile);
        }


        function processCSV(csvText, jsonDataArray) {
            Papa.parse(csvText, {
                header: false,
                skipEmptyLines: true,
                complete: function (results) {
                    const data = results.data;

                    const wellpathStartIndex = data.findIndex(row => row.includes('Wellpath Report'));
                    if (wellpathStartIndex === -1) {
                        console.error("Wellpath Report not found in CSV.");
                        return;
                    }

                    const headers = data[wellpathStartIndex + 1];
                    const wellpathData = data.slice(wellpathStartIndex + 2);

                    // Surface'ın merkezini hesapla
                    const surfaceData = jsonDataArray[2];
                    const centerX = (surfaceData.extent[0][0] + surfaceData.extent[1][0]) / 2;
                    const centerY = (surfaceData.extent[0][1] + surfaceData.extent[1][1]) / 2;

                    let x = [];
                    let y = [];
                    const z = [];

                    let previousX = 0;
                    let previousY = 0;

                    wellpathData.forEach(row => {
                        const verticalSectionStr = row[headers.indexOf('Vertical Section[m]')];
                        const aziDegStr = row[headers.indexOf('Azi[deg]')];
                        const tvdStr = row[headers.indexOf('TVD[m]')];

                        if (!verticalSectionStr || !aziDegStr || !tvdStr) {
                            console.error("Missing data in row:", row);
                            return;
                        }

                        const verticalSection = parseFloat(verticalSectionStr.replace(',', '.'));
                        const aziDeg = parseFloat(aziDegStr.replace(',', '.'));
                        const tvd = parseFloat(tvdStr.replace(',', '.'));

                        if (isNaN(verticalSection) || isNaN(aziDeg) || isNaN(tvd)) {
                            console.error(`Invalid data: Vertical Section = ${verticalSection}, Azi = ${aziDeg}, TVD = ${tvd}`);
                            return;
                        }

                        const aziRad = aziDeg * (Math.PI / 180);

                        if (aziDeg === 0 && x.length > 0 && y.length > 0) {
                            x.push(previousX);
                            y.push(previousY);
                        } else {
                            previousX = verticalSection * Math.sin(aziRad);
                            previousY = verticalSection * Math.cos(aziRad);
                            x.push(previousX);
                            y.push(previousY);
                        }

                        z.push(-tvd + surfaceData.extent[1][2]); // simetriği
                    });

                    // Well Path verilerini yüzeyin merkezine göre kaydırma
                    x = x.map(v => v + centerX);
                    y = y.map(v => v + centerY);

                    const wellTrace = {
                        x: x,
                        y: y,
                        z: z,
                        mode: 'lines',
                        type: 'scatter3d',
                        line: {
                            color: 'blue',
                            width: 4
                        }
                    };

                    const paletteSelect = document.getElementById('palette-select');

                    paletteSelect.addEventListener('change', () => {
                        updatePlot();
                    });

                    function updatePlot() {
                        const selectedPalette = paletteSelect.value;

                        const surfaceTraces = jsonDataArray.map((data, index) => {
                            const binsX = data.bins[0];
                            const binsY = data.bins[1];
                            const extentX = data.extent[0][0];
                            const extentY = data.extent[0][1];
                            const points = data.points;

                            let x = [];
                            let y = [];
                            let z = [];

                            for (let i = 0; i < binsX; i++) {
                                x.push(extentX + i * data.increment[0]);
                            }

                            for (let j = 0; j < binsY; j++) {
                                y.push(extentY + j * data.increment[1]);
                            }

                            for (let j = 0; j < binsY; j++) {
                                let row = [];
                                for (let i = 0; i < binsX; i++) {
                                    row.push(points[j * binsX + i]);
                                }
                                z.push(row);
                            }
                            return {
                                z: z,
                                x: x,
                                y: y,
                                type: 'surface',
                                colorscale: selectedPalette, // Seçilen renk skalası
                                name: `Surface ${index + 1}`,
                                colorbar: {
                                    len: 0.6, // Renk çubuğunun uzunluğunu ayarlayabilirsiniz
                                    thickness: 10, // Renk çubuğunun kalınlığı
                                    tickfont: {
                                        size: 12, // Yazı boyutunu küçülttük
                                        color: 'black' // Yazı rengi
                                    },
                                    title: {
                                        text: `Surface ${index + 1}`, // Renk çubuğu başlığı
                                        font: {
                                            size: 12, // Başlık yazı boyutu
                                            color: 'black' // Başlık yazı rengi
                                        },
                                        side: 'right'
                                    },
                                    x: 1.5 + index * 0.15, // Renk çubuğunu yatayda kaydır
                                    y: 0.7 // Tüm renk çubuklarını aynı hizaya getirin
                                }
                            };

                        });


                        // Add direction arrow
                        const arrowTrace = {
                            type: 'scatter3d',
                            mode: 'lines',
                            x: [centerX, centerX],
                            y: [centerY, centerY + 10000], // Burada boyutu artırdık
                            z: [surfaceData.extent[1][2], surfaceData.extent[1][2]],
                            line: {
                                color: 'red',
                                width: 5
                            },
                            name: 'Kuzey Yönü'
                        };

                        const layout = {
                            title: 'Kuyu Ve Yüzey Görselleştirmesi',
                            showlegend: true,
                            scene: {
                                xaxis: { title: 'X Axis' },
                                yaxis: { title: 'Y Axis' },
                                zaxis: { title: 'Z Axis' }
                            }
                        };

                        const combinedData = [...surfaceTraces, wellTrace, arrowTrace];
                        Plotly.newPlot('combined-plot', combinedData, layout);
                        document.getElementById('palette-container').style.display = 'block';
                    }

                    updatePlot();
                }
            });
        }
    </script>
</body>
</html>
